---
title: "R Notebook"
output: html_notebook
---

```{r}
library(Seurat)
library(Signac)
library(ggplot2)
```

```{r}
if(dir.exists("../Figure3_src/")) {unlink("../Figure3_src",recursive = TRUE)}
dir.create("../Figure3_src")
```



```{r}
integrated <- readRDS("~/snakemake/integration/integrated_3active.Rds")
```

```{r}
colors <- scales::hue_pal()(5)

p4 <- DimPlot(integrated[,integrated$orig.ident == "H3K27ac"], group.by = 'cell_type', pt.size = 1) + ggplot2::ggtitle("H3K27ac") + NoLegend() + NoAxes() +
  scale_color_manual(values = c("Astrocytes"=colors[1],"mOL"=colors[2],"OEC"=colors[3],"VLMC"=colors[4],"OPC"=colors[5]))
p5 <- DimPlot(integrated[,integrated$orig.ident == "H3K4me3"], group.by = 'cell_type', pt.size = 1) + ggplot2::ggtitle("H3K4me3") + NoLegend() + NoAxes() + 
  scale_color_manual(values = c("Astrocytes"=colors[1],"mOL"=colors[2],"OEC"=colors[3],"VLMC"=colors[4],"OPC"=colors[5]))
p6 <- DimPlot(integrated[,integrated$orig.ident == "H3K36me3"], group.by = 'cell_type', pt.size = 1) + ggplot2::ggtitle("H3K36me3") + NoLegend() + NoAxes() + 
  scale_color_manual(values = c("Astrocytes"=colors[1],"mOL"=colors[2],"OEC"=colors[3],"VLMC"=colors[4],"COP-NFOL"=colors[5],"4"="white"))


AugmentPlot(p4)+ AugmentPlot(p5) + AugmentPlot(p6)
ggsave(filename = "../Figure3_src/active3_integrated.pdf",width = 9,height = 3)
```


```{r}
integrated.k27ac <-integrated[,integrated$orig.ident == "H3K27ac"] 

integrated.k27ac <- FindNeighbors(
  object = integrated.k27ac,
  reduction = 'integratedLSI',
  dims = 2:50
)
integrated.k27ac <- FindClusters(
  object = integrated.k27ac,
  algorithm = 3,
  resolution = 0.2,
  verbose = FALSE
)

p1 <- DimPlot(integrated.k27ac)
p2 <- DimPlot(integrated.k27ac,group.by = 'cell_type')
p1+p2

p3 <- DimPlot(brain.H3K27ac) + coord_cartesian(xlim=c(-8,8),ylim=c(-10,10))
p4 <- DimPlot(brain.H3K27ac[,colnames(integrated.k27ac[,integrated.k27ac@active.ident==7])],pt.size=0.2) + coord_cartesian(xlim=c(-8,8),ylim=c(-10,10))
p1+p2
p3+p4
```



```{r}
H3K4me3.coembed <- readRDS("~/snakemake/figures_paper/H3K4me3/integration_RNA/H3K4me3_RNA_coembed.Rds")

DimPlot(H3K4me3.coembed[,H3K4me3.coembed$orig.ident=='H3K4me3'])
DimPlot(H3K4me3.coembed[,H3K4me3.coembed$orig.ident=='scRNA'])

p1 <- DimPlot(H3K4me3.coembed[,H3K4me3.coembed$orig.ident=='H3K4me3'],pt.size = 1) + NoLegend() + NoAxes()
p2 <- DimPlot(H3K4me3.coembed[,H3K4me3.coembed$orig.ident=='scRNA'],pt.size = 1) + NoLegend() + NoAxes()

AugmentPlot(p1) + AugmentPlot(p2)
ggsave(filename = "../Figure3_src/H3K4me3_RNA_coembed.pdf",width=6,height=3)
```


```{r}
load("~/snakemake/figures_paper/H3K4me3/breadth/spreading.Rdata")

ann_row <- mOL.signature[,c('cluster','pseudotime'),drop=FALSE]


# Sort the cells in the heatmap by mOL Signature
ann_row    <- ann_row[order(ann_row$pseudotime),]

########################### OLG lineage

# Sample less cells for faster plotting
OPCs <- rownames(ann_row[ann_row$cluster == 'OPC',])
mOLs <- sample(rownames(ann_row[ann_row$cluster == 'mOL',]),1000)

# Select only OPCs and mOLS
ann_row <- ann_row[c(OPCs,mOLs),]
ann_row$cluster <- factor(as.character(ann_row$cluster),levels=c("OPC","mOL"))
ann_row <- ann_row[order(ann_row$pseudotime),]

# Sepcify the colors
ann_colors                 <- list("cluster"=scales::hue_pal()(5)[c(2,5)])
names(ann_colors$cluster)  <- levels(ann_row$cluster)


# Adapt the color scale
# breaks         <- seq(from = data.range[1],to= data.range[1] + 0.5 * (data.range[2]-data.range[1]),length.out = 11)
breaks         <- seq(0,quantile(distances.to.promoters.heatmap,0.99),length.out = 11)

pheatmap(distances.to.promoters.heatmap[rownames(ann_row),17000:30000],
         cluster_cols = FALSE,cluster_rows = FALSE,labels_col = FALSE,labels_row = FALSE,
         annotation_row = ann_row,annotation_colors = ann_colors,
         viridis::viridis(10),breaks=breaks,fontsize = 22,
         filename = "../Figure3_src/spreading_heatmap_H3K4me3.png",width = 10,height=10)

```

```{r}
rm(list=ls())

cds <- readRDS("~/snakemake/figures_paper/H3K4me3/pseudotime/pseudotime_cds.Rds")

plot_cells(cds,
           color_cells_by = "pseudotime",
           label_cell_groups=FALSE,
           label_leaves=FALSE,
           label_branch_points=FALSE,
           graph_label_size=1.5,cell_size = 1)

ggsave("../FigureS3_src/pseudotime.pdf")
```





